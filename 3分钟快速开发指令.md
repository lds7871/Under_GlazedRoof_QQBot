# 🚀 QQ Bot 指令快速开发指南

快速学会如何创建自己的 QQ Bot 指令

---

## 📋 目录

1. [架构概览](#1-架构概览)
2. [开发两种类型指令](#2-开发两种类型指令)
3. [完整示例](#3-完整示例)
4. [工具方法速查](#4-工具方法速查)
5. [常见错误避坑](#5-常见错误避坑)

---

## 1. 架构概览

### 指令类系统

```
Command (接口)
    ↑
    │ 实现
    │
BaseCommand (抽象基类)
    ├─ 提供验证、参数处理工具
    ├─ 普通指令继承这个
    │
    └─ TemplateMarkdownCommand (Markdown 专用)
        └─ Markdown/Ark 指令继承这个
```

### 核心接口：`Command.java`

```java
public interface Command {
  String getName();              // 指令名称（如 "echo"）
  String getDescription();       // 指令描述（如 "重复输入"）
  String getUsage();             // 用法说明
  String execute(String[] args) throws Exception;  // 执行指令
}
```

### 基类：`BaseCommand.java`

提供三个工具方法：

| 方法 | 用途 | 返回值 |
|------|------|--------|
| `validateArgs(args, count)` | 精确参数数量检查 | 错误信息或 null |
| `validateMinArgs(args, count)` | 最少参数数量检查 | 错误信息或 null |
| `joinArgs(args, startIndex)` | 连接参数为字符串 | 连接后的字符串 |

---

## 2. 开发两种类型指令

### 类型 A：普通指令（纯文本回复）

继承 `BaseCommand`，返回纯文本

#### 代码模板

```java
package org.example.commands;

import org.springframework.stereotype.Component;

@Component
public class MyCommand extends BaseCommand {

  @Override
  public String getName() {
    return "mycmd";  // 指令名称
  }

  @Override
  public String getDescription() {
    return "我的自定义指令";  // 简短描述
  }

  @Override
  public String getUsage() {
    return "用法：/mycmd [参数1] [参数2]\n例子：/mycmd hello world";
  }

  @Override
  public String execute(String[] args) {
    // 1️⃣ 参数验证
    String validation = validateMinArgs(args, 1);
    if (validation != null) {
      return validation;
    }

    // 2️⃣ 逻辑处理
    String result = "你输入了：" + joinArgs(args, 0);

    // 3️⃣ 返回结果
    return result;
  }
}
```

### 类型 B：Markdown 指令（富文本/卡片回复）！！！日活没2000不配用

- 继承 `TemplateMarkdownCommand`，返回 JSON 格式的 Markdown 模板
- 注意，MarkDown需要QQ开放平台审核开通，开通后写模板还要审核，审核完机器人日活没2000依旧不能使用
- 输出格式要与你的模板相对应

#### 代码模板

```java
package org.example.commands;

import org.springframework.stereotype.Component;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Component
public class MyMarkdownCommand extends TemplateMarkdownCommand {

  // 常量定义
  private static final String TEMPLATE_ID = "你的模板ID";

  @Override
  public String getName() {
    return "mymd";
  }

  @Override
  public String getDescription() {
    return "我的 Markdown 指令";
  }

  @Override
  public String getUsage() {
    return "用法：/mymd [参数]";
  }

  // ⭐ 返回模板 ID
  @Override
  protected String getMarkdownTemplateId() {
    return TEMPLATE_ID;
  }

  // ⭐ 返回模板参数列表
  @Override
  protected List<Map<String, Object>> getMarkdownParams(String[] args) throws Exception {
    List<Map<String, Object>> params = new ArrayList<>();

    // 构建参数项
    params.add(buildMarkdownParam("title", "我的标题"));
    params.add(buildMarkdownParam("content", "我的内容"));

    return params;
  }
}
```

#### 实际例子：MarkDownTestCommand（图片指令）

```java
@Component
public class MarkDownTestCommand extends TemplateMarkdownCommand {

  private static final String TEMPLATE_ID = "102813362_1760679605";
  private static final String DEFAULT_IMAGE_URL = 
    "https://q.qq.com/qqbot/static/images/f3648b8001dfa331020c096a85057715.png";

  @Override
  public String getName() {
    return "img";
  }

  @Override
  public String getDescription() {
    return "发送图片消息示例";
  }

  @Override
  public String getUsage() {
    return "/img [URL] - 可选指定图片 URL";
  }

  @Override
  protected String getMarkdownTemplateId() {
    return TEMPLATE_ID;  // 官方图片模板
  }

  @Override
  protected List<Map<String, Object>> getMarkdownParams(String[] args) throws Exception {
    List<Map<String, Object>> params = new ArrayList<>();

    // 提取 URL（有参数用参数，无参数用默认）
    String imageUrl = (args.length > 0 && args[0].startsWith("http"))
      ? args[0]
      : DEFAULT_IMAGE_URL;

    // 只需要 ReturnImg 参数
    params.add(buildMarkdownParam("ReturnImg", imageUrl));

    return params;
  }
}
```

**输出格式**：

```json
{
  "msg_type": 2,
  "markdown": {
    "custom_template_id": "102813362_1760679605",
    "params": [
      {
        "key": "ReturnImg",
        "values": ["https://example.com/image.png"]
      }
    ]
  }
}
```

---

## 3. 工具方法速查

### BaseCommand 提供的方法

#### 1. 参数验证

```java
// 精确参数数量（必须等于 count）
String error = validateArgs(args, 2);
if (error != null) return error;

// 最少参数数量（必须 >= minCount）
String error = validateMinArgs(args, 1);
if (error != null) return error;
```

#### 2. 参数处理

```java
// 连接参数为字符串
String result = joinArgs(args, 0);     // 连接全部
String result = joinArgs(args, 1);     // 从第二个开始连接
```

### TemplateMarkdownCommand 提供的方法

#### 1. 构建参数项

```java
// 单值参数
buildMarkdownParam("key", "value")
  ↓
{"key": "key", "values": ["value"]}

// 多值参数
buildMarkdownParam("key", "val1", "val2", "val3")
  ↓
{"key": "key", "values": ["val1", "val2", "val3"]}
```

#### 2. 自动生成完整消息

```java
// 不需要手动调用！execute() 已自动调用
protected String buildTemplateMarkdownMessage(List<Map<String, Object>> params)
// 返回 JSON 格式的完整消息
```

---


---

## 🎯 开发清单

新建指令时的检查表：

- [ ] 类名有意义（如 `MyCommand`）
- [ ] 添加 `@Component` 注解
- [ ] 继承了正确的基类（`BaseCommand` 或 `TemplateMarkdownCommand`）
- [ ] 实现了所有必要方法（`getName`、`getDescription`、`getUsage`、`execute`）
- [ ] `execute()` 方法签名包含 `throws Exception`
- [ ] 参数验证：使用 `validateArgs()` 或 `validateMinArgs()`
- [ ] 错误处理：返回有意义的错误消息，不返回 null
- [ ] 测试：编译并在 QQ 机器人中测试
- [ ] 重启服务让 Spring 加载新指令

---

## 🚀 快速命令

```bash
# 编译项目
mvn clean compile

# 启动 Java 服务
mvn spring-boot:run

# 在 QQ 中测试
/help mycmd
/mycmd [参数]
```

---

**完成！现在你已经掌握了如何开发 QQ Bot 指令 🎉**
